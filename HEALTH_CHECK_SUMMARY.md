# System Health Check Report
**Date:** November 8, 2025
**Generated by:** Automated Health Check Scripts

---

## üéØ Overall Status

### API Health: ‚úÖ GOOD
**Score:** 11/11 passed, 1 warning

### Cronjob Health: ‚ö†Ô∏è PARTIAL
**Score:** Running on schedule, but 2/3 entity syncs failing

---

## üì° API Health Details

### ‚úÖ All Systems Operational:
- Pendo API Key configured and valid
- All 4 Pendo endpoints responding (200 OK)
  - Pages ‚úÖ
  - Features ‚úÖ
  - Guides ‚úÖ
  - Reports ‚úÖ
- API rate limits healthy (5 concurrent requests in 801ms)
- Supabase database connected
- All 5 database tables accessible

### Database Record Counts:
| Table | Records | Status |
|-------|---------|--------|
| pendo_guides | 548 | ‚úÖ |
| pendo_features | 956 | ‚úÖ |
| pendo_pages | 358 | ‚úÖ |
| pendo_reports | 485 | ‚úÖ |
| pendo_events | 15,519 | ‚úÖ |

### ‚ö†Ô∏è Minor Issue:
- `SUPABASE_SERVICE_ROLE_KEY` env variable not set
- **Impact:** Limited cronjob monitoring capabilities
- **Action:** Consider adding to `.env` for full functionality

---

## ‚è∞ Cronjob Health Details

### ‚úÖ Schedule: Running Correctly
- **Frequency:** Every 6 hours
- **Schedule:** 00:00, 06:00, 12:00, 18:00 UTC
- **Last Run:** 8/11/2025, 8:23 AM (just now)
- **Next Run:** 8/11/2025, 1:00 PM (in 4.6 hours)
- **Status:** ‚úÖ On time

### ‚ùå Sync Failures Detected

#### Pages Sync: ‚úÖ WORKING
- Status: Completed
- Records: 358
- Last sync: 8/11/2025, 8:23 AM

#### Features Sync: ‚ùå FAILING
- Status: Failed (last 5 attempts)
- Records: 0
- **Error:** `ON CONFLICT DO UPDATE command cannot affect row a second time`
- **Cause:** Duplicate records in API response causing upsert conflict

#### Guides Sync: ‚ùå FAILING
- Status: Failed (last 5 attempts)
- Records: 0
- **Error:** `ON CONFLICT DO UPDATE command cannot affect row a second time`
- **Cause:** Duplicate records in API response causing upsert conflict

---

## üîç Root Cause Analysis

### The "ON CONFLICT" Error

**What's happening:**
The Pendo API returns duplicate records for Features and Guides (same records with same IDs appearing multiple times in the response). When the Edge Function tries to upsert these, PostgreSQL detects that the same row would be updated twice in a single statement and throws an error.

**Evidence:**
- Pages sync works fine (no duplicates)
- Features and Guides fail consistently (duplicates present)
- Error message specifically mentions "cannot affect row a second time"

**Why this happens:**
Remember from our earlier testing:
```
Features - Offset 0: 956 records
Features - Offset 500: Same 956 records (duplicates!)
```

The sync script might be:
1. Fetching with pagination
2. Getting duplicate records from Pendo API
3. Trying to upsert all at once
4. PostgreSQL rejecting duplicate upserts

---

## üîß Recommended Fixes

### Priority 1: Fix Duplicate Upsert Issue (CRITICAL)

**Option A: Deduplicate Before Upsert** (Recommended)
Update the Edge Function to remove duplicates before upserting:

```typescript
// In supabase/functions/sync-pendo-incremental/index.ts
const uniqueRecords = Array.from(
  new Map(results.map(item => [item.id, item])).values()
);

// Then upsert uniqueRecords instead of results
```

**Option B: Batch Upsert**
Instead of upserting all records at once, upsert in smaller batches or one at a time.

**Option C: Use DISTINCT in Query**
If possible, modify the Pendo API query to return only distinct records.

### Priority 2: Monitor Edge Function Logs

Check Supabase Edge Function logs:
1. Go to: https://supabase.com/dashboard/project/nrutlzclujyejusvbafm
2. Navigate to: Edge Functions > sync-pendo-incremental > Logs
3. Look for full error stack traces
4. Verify the exact line causing the failure

### Priority 3: Test Fix Locally

```bash
# After fixing the Edge Function:
cd supabase/functions/sync-pendo-incremental
supabase functions serve sync-pendo-incremental

# Then test manually:
curl -X POST http://localhost:54321/functions/v1/sync-pendo-incremental \
  -H "Authorization: Bearer YOUR_ANON_KEY" \
  -H "Content-Type: application/json"
```

---

## üìä Impact Assessment

### Current Impact:
- ‚ùå **Features not syncing** - Data is stale (last successful sync unknown)
- ‚ùå **Guides not syncing** - Data is stale (last successful sync unknown)
- ‚úÖ **Pages syncing normally** - Data fresh (syncs every 6 hours)
- ‚ö†Ô∏è **Missing 50% of data** - Multi-app issue (see AUDIT_REPORT.md)

### Business Impact:
- Dashboard shows incomplete/stale data for Features and Guides
- Analytics based on these entities will be inaccurate
- Reports may show outdated information

### User Impact:
- LOW - Most users viewing Pages (which works)
- MEDIUM - Users analyzing Features/Guides see old data
- HIGH - If used for business decisions, could lead to wrong conclusions

---

## ‚úÖ Immediate Action Items

### For Development Team:

1. **Fix Edge Function Duplicate Handling** (30 min)
   - [ ] Update sync-pendo-incremental/index.ts
   - [ ] Add deduplication logic
   - [ ] Test locally
   - [ ] Deploy to Supabase

2. **Test Fix** (15 min)
   - [ ] Trigger manual sync: `SELECT call_pendo_sync_edge_function();`
   - [ ] Check sync_status table for success
   - [ ] Verify record counts in database

3. **Monitor Next Scheduled Run** (5 min)
   - [ ] Wait for next cron run (1:00 PM UTC)
   - [ ] Check if Features/Guides sync successfully
   - [ ] Confirm no more errors in logs

### For Product/Business:

4. **Contact Pendo Support** (ONGOING - from AUDIT_REPORT)
   - [ ] Inquire about multiple apps (748 pages vs 358)
   - [ ] Request API access to all apps
   - [ ] Ask about API pagination issues

---

## üõ†Ô∏è Health Check Commands

You can run these anytime to check system status:

```bash
# Check API connectivity and database
node scripts/health-check-api.mjs

# Check cronjob status and sync history
node scripts/health-check-cronjobs.mjs

# Check database vs API counts
node scripts/audit-database-counts.mjs

# Manual sync (if needed)
node scripts/sync-all-pendo-data-batched.mjs
```

---

## üìà Success Metrics

System is healthy when:
- ‚úÖ API health check passes with 0 failures
- ‚úÖ All 3 entity types (Pages, Features, Guides) sync successfully
- ‚úÖ Last sync within 6.5 hours
- ‚úÖ No errors in Edge Function logs
- ‚úÖ Database record counts match Pendo API

---

## üîÑ Next Review

**Recommended frequency:** Daily until issues resolved, then weekly

**Next review date:** November 9, 2025

**What to check:**
1. Are Features/Guides syncing after fix?
2. Any new errors in logs?
3. Response from Pendo support about multi-app access?

---

## üìû Support Resources

- **Health Check Scripts:** `scripts/health-check-*.mjs`
- **Audit Report:** `AUDIT_REPORT.md`
- **Action Plan:** `ACTION_PLAN.md`
- **Cron Setup:** `SUPABASE_CRON_SETUP.md`
- **Edge Function Logs:** https://supabase.com/dashboard
- **Pendo Support:** support@pendo.io

---

**Report generated:** November 8, 2025
**Next scheduled check:** Run `node scripts/health-check-cronjobs.mjs` daily
